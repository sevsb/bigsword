<link rel="stylesheet" href="[:vendor]/bootstrap-select/bootstrap-select.min.css">
<link rel="stylesheet" href="[:vendor]/datatables-plugins/dataTables.bootstrap.min.css">
<link rel="stylesheet" href="[:vendor]/datatables-responsive/dataTables.responsive.min.css">
<link rel="stylesheet" href="[:vendor]/datatables-responsive/dataTables.responsive.scss">
<script type="text/javascript" language="javascript" src="[:vendor]/bootstrap-select/bootstrap-select.min.js"></script>
<script type="text/javascript" language="javascript" src="[:vendor]/datatables-plugins/jquery.dataTables.min.js"></script>
<script type="text/javascript" language="javascript" src="[:vendor]/datatables-plugins/dataTables.bootstrap.min.js"></script>
<script type="text/javascript" language="javascript" src="[:vendor]/datatables-responsive/dataTables.responsive.min.js"></script>

<div id="page-wrapper">
    <div>
        <h3 class="page_title" style='margin-left: 30px; display: inline-block;margin-bottom: 30px;'>本日技师状态列表</h3>
        <a href='?booking'target=""><button style='float: right;margin-top: 15px;' class='btn btn-success'>直接新增订单</button></a>
    </div>
    <?php
    $today = date('Y-m-d');
    $today_stamp = strtotime($today);
    $tomorrow_stamp = strtotime($today) + 3600 * 24;
    $statffs_status = array();
    $today_orders = array();
    $work_or_not = array();
    foreach ($staffs as $staff) {
        $staff_id = $staff->id();
        $is_work = $staff::is_workdate($staff_id, $today_stamp);
        $statffs_status[$staff_id]['is_work'] = $is_work;
    }
    foreach ($orders as $order) {
        $id = $order->id();
        $staff_id = $order->staff_id();
        $start_time = $order->start_time();
        if ($start_time < $tomorrow_stamp && $start_time > $today_stamp) {
            $statffs_status[$staff_id]['orders'][$start_time] = $order;
        }
    }
    //var_dump($statffs_status);
    ?>
    <hr style='margin-top:0px;'>
    <div class='staff_status_list'>
    <div class='staff_status fst'>
        <div class='staff_status_head fst text-center'>技师</div>
        <div class='staff_status_body fst'>
        <?php
        $clock = 9;
        $j = 0;
        for($i = 0; $i < 54; $i++) {
            $echo ='';
            if($i % 6 == 0){
                $echo = $clock + $j . ":00" ;
                $j++;
            }
        ?>
        <div class='time_block_info'>
        {:$echo}
        </div>
        <?php
        }
        ?>
        </div>
    </div>
    <?php
    foreach ($staffs as $staff) {
        $staff_id = $staff->id();
        $name = $staff->name();
        $photo_thumbnail_url = $staff->photo_thumbnail_url();
        $is_work = $statffs_status[$staff_id]['is_work']['ret'];
        ?>
        <div class='staff_status' staff_id="{:$staff_id}">
            <a href='?booking&staff_id={:$staff_id}'><div class='staff_status_head text-center'>
                <div class='thumb'><img src="{:$photo_thumbnail_url}"></div>
                <div>{:$name}</div>
            </div></a>
            <div class='staff_status_body'>
            <?php
            $not_work = $is_work == true ? '' : 'not_work';
            $block_end = $today_stamp + 9 * 60 * 60; 
            $detail_info = $is_work == true ? '' : '此人今日休息';
            for($i = 0; $i < 54; $i++) {
                $block_start = $block_end;
                $block_end = $block_start + 600;
                $has_order = '';
                $order_id = '-1';
                if (!empty($statffs_status[$staff_id]['orders'])) {
                    foreach ($statffs_status[$staff_id]['orders'] as $start_ttime => $order) {
                        $start_time = $order->start_time();
                        $end_time = $order->end_time();
                        if ($block_start >= $start_time && $block_end <= $end_time ) {
                            $has_order = 'has_order';
                            $order_id = $order->id();
                            $service_id = $order->service_id();
                            $service = service::create($service_id);
                            $title = $service->title();
                            $waste_time = $service->waste_time();
                            $detail_info = "
                            项目：$title  
                            时间：$waste_time
                            ";
                        }
                    }
                }
                ?>
                <div class='time_block {:$not_work} {:$has_order}' 
                order_id='{:$order_id}' block_start='{:$block_start}' block_end='{:$block_end}'
                data-toggle="popover" data-placement="top" title="详细信息" data-content="{:$detail_info}">
                </div>
                <?php
            }
            ?>
            </div>
        </div>
        <?php
    }
    ?>


</div>
</div>
<div class=''></div>
<div class=''></div>
<div class=''></div>

<div class="modal fade" id="del-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="myModalLabel">删除确认</h4>
      </div>
      <div class="modal-body">
        <p>确认要删除此项？</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
        <button type="button" class="btn btn-danger do_del">删除</button>
      </div>
    </div>
  </div>
</div>